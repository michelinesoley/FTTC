clear all;
close all;
addpath(genpath('~/Downloads/tensor_toolbox_htucker_1.2'));
addpath(genpath('~/Downloads/TT-Toolbox'));
format long
d=50; % number of dimensions
ns= 601;% # of propagation steps
dump = 100; % Frequency of wavefunction printing
eps=1e-8; % Precision for tt train round off
ceps=1e-8; % Precision for exponential
rmax=3; % Max rank

h = 1; % hbar
alpha=1; % initial width
x0= 1; % initial position
x0array(1)=1.;
for j=2:d
    x0array(j)=x0;
end
p0= 0; % initial momentum
q=5; % quantics
nx=2^q;  % # of grid points in coord representation
np=nx; % # of grid points in momentum representation
L=10; % simulation box
dx= L/nx; % x grid spacing
dp= 2*pi/L; % spacing in momenta space
tau= 0.01; % Time step
Npoly=50; % Number of Chebyshev polynomials

% masses
for j=1:d
    m(j)=1;
end
%
% Build 1-d grids for initial state
for j=1:nx
    x(j)=(j-nx/2)*dx;
    psi(j)=psi0(x(j),p0,x0array(1),alpha);
end

[r1,r2]=meshgrid(x,x); % mesh for 2D represention
[rx,ry,rz]=meshgrid(x,x,x); % mesh for 3D represention
for j=1:np
    if(j<(np/2+2))
        p(j)=(j-1)*dp;
    else
        p(j)=(j-1-np)*dp;
    end
    KE(j)=p(j)^2/2; % Only for mass=1
end
tic;
% Build tensor trains
% Kinetic energy and KE propagator
[KE_tt, KP2_tt] = KEKP(KE,m,nx,d,tau,eps,rmax);
toc;
% Initial state
tic;
G_tt=tt_tensor(psi);
for j=2:d
    for k=1:nx
        psi(k)=psi0(x(k),p0,x0array(j),alpha);
    end
    G_tt = tkron(G_tt,tt_tensor(psi));
end
toc;

% Tensor train Cartesian coordinates r_tt
tic;

r_tt=cell(1,d);
for k=1:d
    ttx=tt_tensor(x);
    if(k == 1)
        r_tt{k}=ttx;
        for j=2:d
            r_tt{k} = tkron(r_tt{k},tt_ones(nx));
        end
    else
        r_tt{k}=tt_ones(nx);           
        for j=2:k-1
            r_tt{k} = tkron(r_tt{k},tt_ones(nx));
        end
        r_tt{k} = tkron(r_tt{k},ttx);
        for j=k+1:d
            r_tt{k} = tkron(r_tt{k},tt_ones(nx));
        end
    end
end
toc;

% Tensor train potential PE_tt
tic;
% DNA potential
verticalscale=0.1;
gamma=0.;
funone = @(z1) verticalscale*(0.429*z1);
funtwo = @(z2) verticalscale*(-1.126*z2);
funthree = @(z3) verticalscale*(-0.143*z3);
funfour = @(z4) verticalscale*(0.563*z4);
funcoup = @(zcoup) verticalscale*(gamma*zcoup);
r1_tt = r_tt{1};
r2_tt = power(r_tt{1},2);
r3_tt = power(r_tt{1},3);
r4_tt = power(r_tt{1},4);
PE_tt = round(funcrs2(r1_tt,funone,eps,r1_tt,8),eps,rmax);
PE_tt = round(PE_tt+round(funcrs2(r2_tt,funtwo,eps,r2_tt,8),eps,rmax),eps,rmax);
PE_tt = round(PE_tt+round(funcrs2(r3_tt,funthree,eps,r3_tt,8),eps,rmax),eps,rmax);
PE_tt = round(PE_tt+round(funcrs2(r4_tt,funfour,eps,r4_tt,8),eps,rmax),eps,rmax);
for jj = 2:d
    r1_tt = r_tt{jj};
    r2_tt = power(r_tt{jj},2);
    r3_tt = power(r_tt{jj},3);
    r4_tt = power(r_tt{jj},4);
    PE_tt = round(PE_tt+round(funcrs2(r1_tt,funone,eps,r1_tt,8),eps,rmax),eps,rmax);
    PE_tt = round(PE_tt+round(funcrs2(r2_tt,funtwo,eps,r2_tt,8),eps,rmax),eps,rmax);
    PE_tt = round(PE_tt+round(funcrs2(r3_tt,funthree,eps,r3_tt,8),eps,rmax),eps,rmax);
    PE_tt = round(PE_tt+round(funcrs2(r4_tt,funfour,eps,r4_tt,8),eps,rmax),eps,rmax);
    rcoup_tt = r_tt{jj}.*r_tt{jj-1};
    PE_tt = round(PE_tt+round(funcrs2(rcoup_tt,funcoup,eps,rcoup_tt,8),eps,rmax),eps,rmax);
end
toc;

% Display PES
if (d < 5)
    figure;
    if(d == 2)
        v1=reshape(full(PE_tt(:,:)),[nx nx]);
    elseif (d == 3)
        v1=reshape(full(PE_tt(:,:,nx/2)),[nx nx]);
    elseif (d == 4)
        v1=reshape(full(PE_tt(:,:,nx/2,nx/2)),[nx nx]);
    end
    surf(r1,r2,v1);
    colormap(jet);
    xlabel('x_1 [au]','fontsize',18);
    ylabel('x_2 [au]','fontsize',18);
    zlabel('Energy [au]','fontsize',18);
    set(gca,'FontSize',15);
    zlim([-1 5])
    grid;
    title('x_1-x_2 Slice of Potential Energy Surface','fontsize',18)
end
%%
tic;
% potential energy propagator: 
PPhalf_tt=round(tt_exp(PE_tt*(-1i*0.5*tau), ceps),eps,rmax);
toc;

% Min/max energies for DNA potential
if d == 2  % 2D
    analyV = @(q) (0.1*(0.429*q(1)-1.126*q(1)^2-0.143*q(1)^3+0.563*q(1)^4)) ...
        +(0.1*(0.429*q(2)-1.126*q(2)^2-0.143*q(2)^3+0.563*q(2)^4)) ...
        +(0.1*(gamma*q(2)*q(1)));
    analyVneg = @(q) -((0.1*(0.429*q(1)-1.126*q(1)^2-0.143*q(1)^3+0.563*q(1)^4)) ...
        +(0.1*(0.429*q(2)-1.126*q(2)^2-0.143*q(2)^3+0.563*q(2)^4))...
        +(0.1*(gamma*q(2)*q(1))));
    lb=[x(1) x(1)];
    ub=[x(nx) x(nx)];
    A=[];
    b=[];
    Aeq=[];
    beq=[];
   q0=(lb+ub)/2;
elseif d == 6  % 6D
    analyV = @(q) (0.1*(0.429*q(1)-1.126*q(1)^2-0.143*q(1)^3+0.563*q(1)^4)) ...
        +(0.1*(0.429*q(2)-1.126*q(2)^2-0.143*q(2)^3+0.563*q(2)^4))...
        +(0.1*(0.429*q(3)-1.126*q(3)^2-0.143*q(3)^3+0.563*q(3)^4)) ...
        +(0.1*(0.429*q(4)-1.126*q(4)^2-0.143*q(4)^3+0.563*q(4)^4)) ...
        +(0.1*(0.429*q(5)-1.126*q(5)^2-0.143*q(5)^3+0.563*q(5)^4))...
        +(0.1*(0.429*q(6)-1.126*q(6)^2-0.143*q(6)^3+0.563*q(6)^4))  ...
        +(0.1*(gamma*q(1)*q(2)))+(0.1*(gamma*q(2)*q(3)))+(0.1*(gamma*q(3)*q(4)))...
        +(0.1*(gamma*q(4)*q(5)))+(0.1*(gamma*q(5)*q(6)));
    analyVneg = @(q) -((0.1*(0.429*q(1)-1.126*q(1)^2-0.143*q(1)^3+0.563*q(1)^4)) ...
        +(0.1*(0.429*q(2)-1.126*q(2)^2-0.143*q(2)^3+0.563*q(2)^4))...
        +(0.1*(0.429*q(3)-1.126*q(3)^2-0.143*q(3)^3+0.563*q(3)^4))...
        +(0.1*(0.429*q(4)-1.126*q(4)^2-0.143*q(4)^3+0.563*q(4)^4)) ...
        +(0.1*(0.429*q(5)-1.126*q(5)^2-0.143*q(5)^3+0.563*q(5)^4))...
        +(0.1*(0.429*q(6)-1.126*q(6)^2-0.143*q(6)^3+0.563*q(6)^4)) ...
        +(0.1*(gamma*q(1)*q(2)))+(0.1*(gamma*q(2)*q(3)))+(0.1*(gamma*q(3)*q(4)))...
        +(0.1*(gamma*q(4)*q(5)))+(0.1*(gamma*q(5)*q(6))));
    lb=[x(1) x(1) x(1) x(1) x(1) x(1)];
    ub=[x(nx) x(nx) x(nx) x(nx) x(nx) x(nx)];
    A=[];
    b=[];
    Aeq=[];
    beq=[];
    q0=(lb+ub)/2;
elseif d == 50  % 50D
    analyV = @(q) (0.1*(0.429*q(1)-1.126*q(1)^2-0.143*q(1)^3+0.563*q(1)^4)) ...
        +(0.1*(0.429*q(2)-1.126*q(2)^2-0.143*q(2)^3+0.563*q(2)^4))...
        +(0.1*(0.429*q(3)-1.126*q(3)^2-0.143*q(3)^3+0.563*q(3)^4)) ...
        +(0.1*(0.429*q(4)-1.126*q(4)^2-0.143*q(4)^3+0.563*q(4)^4)) ...
        +(0.1*(0.429*q(5)-1.126*q(5)^2-0.143*q(5)^3+0.563*q(5)^4))...
        +(0.1*(0.429*q(6)-1.126*q(6)^2-0.143*q(6)^3+0.563*q(6)^4))...
        +(0.1*(0.429*q(7)-1.126*q(7)^2-0.143*q(7)^3+0.563*q(7)^4)) ...
        +(0.1*(0.429*q(8)-1.126*q(8)^2-0.143*q(8)^3+0.563*q(8)^4))...
        +(0.1*(0.429*q(9)-1.126*q(9)^2-0.143*q(9)^3+0.563*q(9)^4)) ...
        +(0.1*(0.429*q(10)-1.126*q(10)^2-0.143*q(10)^3+0.563*q(10)^4)) ...
        +(0.1*(0.429*q(11)-1.126*q(11)^2-0.143*q(11)^3+0.563*q(11)^4))...
        +(0.1*(0.429*q(12)-1.126*q(12)^2-0.143*q(12)^3+0.563*q(12)^4))...
        +(0.1*(0.429*q(13)-1.126*q(13)^2-0.143*q(13)^3+0.563*q(13)^4)) ...
        +(0.1*(0.429*q(14)-1.126*q(14)^2-0.143*q(14)^3+0.563*q(14)^4))...
        +(0.1*(0.429*q(15)-1.126*q(15)^2-0.143*q(15)^3+0.563*q(15)^4)) ...
        +(0.1*(0.429*q(16)-1.126*q(16)^2-0.143*q(16)^3+0.563*q(16)^4)) ...
        +(0.1*(0.429*q(17)-1.126*q(17)^2-0.143*q(17)^3+0.563*q(17)^4))...
        +(0.1*(0.429*q(18)-1.126*q(18)^2-0.143*q(18)^3+0.563*q(18)^4))...
        +(0.1*(0.429*q(19)-1.126*q(19)^2-0.143*q(19)^3+0.563*q(19)^4)) ...
        +(0.1*(0.429*q(20)-1.126*q(20)^2-0.143*q(20)^3+0.563*q(20)^4))...
        +(0.1*(0.429*q(21)-1.126*q(21)^2-0.143*q(21)^3+0.563*q(21)^4)) ...
        +(0.1*(0.429*q(22)-1.126*q(22)^2-0.143*q(22)^3+0.563*q(22)^4)) ...
        +(0.1*(0.429*q(23)-1.126*q(23)^2-0.143*q(23)^3+0.563*q(23)^4))...
        +(0.1*(0.429*q(24)-1.126*q(24)^2-0.143*q(24)^3+0.563*q(24)^4))...
        +(0.1*(0.429*q(25)-1.126*q(25)^2-0.143*q(25)^3+0.563*q(25)^4)) ...
        +(0.1*(0.429*q(26)-1.126*q(26)^2-0.143*q(26)^3+0.563*q(26)^4))...
        +(0.1*(0.429*q(27)-1.126*q(27)^2-0.143*q(27)^3+0.563*q(27)^4)) ...
        +(0.1*(0.429*q(28)-1.126*q(28)^2-0.143*q(28)^3+0.563*q(28)^4)) ...
        +(0.1*(0.429*q(29)-1.126*q(29)^2-0.143*q(29)^3+0.563*q(29)^4))...
        +(0.1*(0.429*q(30)-1.126*q(30)^2-0.143*q(30)^3+0.563*q(30)^4))...
        +(0.1*(0.429*q(31)-1.126*q(31)^2-0.143*q(31)^3+0.563*q(31)^4)) ...
        +(0.1*(0.429*q(32)-1.126*q(32)^2-0.143*q(32)^3+0.563*q(32)^4))...
        +(0.1*(0.429*q(33)-1.126*q(33)^2-0.143*q(33)^3+0.563*q(33)^4)) ...
        +(0.1*(0.429*q(34)-1.126*q(34)^2-0.143*q(34)^3+0.563*q(34)^4)) ...
        +(0.1*(0.429*q(35)-1.126*q(35)^2-0.143*q(35)^3+0.563*q(35)^4))...
        +(0.1*(0.429*q(36)-1.126*q(36)^2-0.143*q(36)^3+0.563*q(36)^4))...
        +(0.1*(0.429*q(37)-1.126*q(37)^2-0.143*q(37)^3+0.563*q(37)^4))...
        +(0.1*(0.429*q(38)-1.126*q(38)^2-0.143*q(38)^3+0.563*q(38)^4)) ...
        +(0.1*(0.429*q(39)-1.126*q(39)^2-0.143*q(39)^3+0.563*q(39)^4)) ...
        +(0.1*(0.429*q(40)-1.126*q(40)^2-0.143*q(40)^3+0.563*q(40)^4))...
        +(0.1*(0.429*q(41)-1.126*q(41)^2-0.143*q(41)^3+0.563*q(41)^4))...
        +(0.1*(0.429*q(42)-1.126*q(42)^2-0.143*q(42)^3+0.563*q(42)^4))...
        +(0.1*(0.429*q(43)-1.126*q(43)^2-0.143*q(43)^3+0.563*q(43)^4))...
        +(0.1*(0.429*q(44)-1.126*q(44)^2-0.143*q(44)^3+0.563*q(44)^4))...
        +(0.1*(0.429*q(45)-1.126*q(45)^2-0.143*q(45)^3+0.563*q(45)^4))...
        +(0.1*(0.429*q(46)-1.126*q(46)^2-0.143*q(46)^3+0.563*q(46)^4))...
        +(0.1*(0.429*q(47)-1.126*q(47)^2-0.143*q(47)^3+0.563*q(47)^4))...
        +(0.1*(0.429*q(48)-1.126*q(48)^2-0.143*q(48)^3+0.563*q(48)^4))...
        +(0.1*(0.429*q(49)-1.126*q(49)^2-0.143*q(49)^3+0.563*q(49)^4))...
        +(0.1*(0.429*q(50)-1.126*q(50)^2-0.143*q(50)^3+0.563*q(50)^4))...
        +(0.1*(gamma*q(1)*q(2)))+(0.1*(gamma*q(2)*q(3)))+(0.1*(gamma*q(3)*q(4)))...
        +(0.1*(gamma*q(4)*q(5)))+(0.1*(gamma*q(5)*q(6)))+(0.1*(gamma*q(6)*q(7)))...
        +(0.1*(gamma*q(7)*q(8)))+(0.1*(gamma*q(8)*q(9)))+(0.1*(gamma*q(9)*q(10)))...
        +(0.1*(gamma*q(10)*q(11)))+(0.1*(gamma*q(11)*q(12)))+(0.1*(gamma*q(12)*q(13)))...
        +(0.1*(gamma*q(13)*q(14)))+(0.1*(gamma*q(14)*q(15)))+(0.1*(gamma*q(15)*q(16)))...
        +(0.1*(gamma*q(16)*q(17)))+(0.1*(gamma*q(17)*q(18)))+(0.1*(gamma*q(18)*q(19)))...
        +(0.1*(gamma*q(19)*q(20)))+(0.1*(gamma*q(20)*q(21)))+(0.1*(gamma*q(21)*q(22)))...
        +(0.1*(gamma*q(22)*q(23)))+(0.1*(gamma*q(23)*q(24)))+(0.1*(gamma*q(24)*q(25)))...
        +(0.1*(gamma*q(25)*q(26)))+(0.1*(gamma*q(26)*q(27)))+(0.1*(gamma*q(27)*q(28)))...
        +(0.1*(gamma*q(28)*q(29)))+(0.1*(gamma*q(29)*q(30)))+(0.1*(gamma*q(30)*q(31)))...
        +(0.1*(gamma*q(31)*q(32)))+(0.1*(gamma*q(32)*q(33)))+(0.1*(gamma*q(33)*q(34)))...
        +(0.1*(gamma*q(34)*q(35)))+(0.1*(gamma*q(35)*q(36)))+(0.1*(gamma*q(36)*q(37)))...
        +(0.1*(gamma*q(37)*q(38)))+(0.1*(gamma*q(38)*q(39)))+(0.1*(gamma*q(39)*q(40)))...
        +(0.1*(gamma*q(40)*q(41)))+(0.1*(gamma*q(41)*q(42)))+(0.1*(gamma*q(42)*q(43)))...
        +(0.1*(gamma*q(43)*q(44)))+(0.1*(gamma*q(44)*q(45)))+(0.1*(gamma*q(45)*q(46)))...
        +(0.1*(gamma*q(46)*q(47)))+(0.1*(gamma*q(47)*q(48)))+(0.1*(gamma*q(48)*q(49)))...
        +(0.1*(gamma*q(49)*q(50)));
    analyVneg = @(q) -((0.1*(0.429*q(1)-1.126*q(1)^2-0.143*q(1)^3+0.563*q(1)^4)) ...
        +(0.1*(0.429*q(2)-1.126*q(2)^2-0.143*q(2)^3+0.563*q(2)^4))...
        +(0.1*(0.429*q(3)-1.126*q(3)^2-0.143*q(3)^3+0.563*q(3)^4))...
        +(0.1*(0.429*q(4)-1.126*q(4)^2-0.143*q(4)^3+0.563*q(4)^4)) ...
        +(0.1*(0.429*q(5)-1.126*q(5)^2-0.143*q(5)^3+0.563*q(5)^4))...
        +(0.1*(0.429*q(6)-1.126*q(6)^2-0.143*q(6)^3+0.563*q(6)^4))...
        +(0.1*(0.429*q(7)-1.126*q(1)^2-0.143*q(7)^3+0.563*q(7)^4)) ...
        +(0.1*(0.429*q(8)-1.126*q(2)^2-0.143*q(8)^3+0.563*q(8)^4))...
        +(0.1*(0.429*q(9)-1.126*q(3)^2-0.143*q(9)^3+0.563*q(9)^4)) ...
        +(0.1*(0.429*q(10)-1.126*q(4)^2-0.143*q(10)^3+0.563*q(10)^4)) ...
        +(0.1*(0.429*q(11)-1.126*q(5)^2-0.143*q(11)^3+0.563*q(11)^4))...
        +(0.1*(0.429*q(12)-1.126*q(6)^2-0.143*q(12)^3+0.563*q(12)^4))...
        +(0.1*(0.429*q(13)-1.126*q(13)^2-0.143*q(13)^3+0.563*q(13)^4))...
        +(0.1*(0.429*q(14)-1.126*q(14)^2-0.143*q(14)^3+0.563*q(14)^4))...
        +(0.1*(0.429*q(15)-1.126*q(15)^2-0.143*q(15)^3+0.563*q(15)^4)) ...
        +(0.1*(0.429*q(16)-1.126*q(16)^2-0.143*q(16)^3+0.563*q(16)^4)) ...
        +(0.1*(0.429*q(17)-1.126*q(17)^2-0.143*q(17)^3+0.563*q(17)^4))...
        +(0.1*(0.429*q(18)-1.126*q(18)^2-0.143*q(18)^3+0.563*q(18)^4))...
        +(0.1*(0.429*q(19)-1.126*q(19)^2-0.143*q(19)^3+0.563*q(19)^4)) ...
        +(0.1*(0.429*q(20)-1.126*q(20)^2-0.143*q(20)^3+0.563*q(20)^4))...
        +(0.1*(0.429*q(21)-1.126*q(21)^2-0.143*q(21)^3+0.563*q(21)^4)) ...
        +(0.1*(0.429*q(22)-1.126*q(22)^2-0.143*q(22)^3+0.563*q(22)^4)) ...
        +(0.1*(0.429*q(23)-1.126*q(23)^2-0.143*q(23)^3+0.563*q(23)^4))...
        +(0.1*(0.429*q(24)-1.126*q(24)^2-0.143*q(24)^3+0.563*q(24)^4))...
        +(0.1*(0.429*q(25)-1.126*q(25)^2-0.143*q(25)^3+0.563*q(25)^4)) ...
        +(0.1*(0.429*q(26)-1.126*q(26)^2-0.143*q(26)^3+0.563*q(26)^4))...
        +(0.1*(0.429*q(27)-1.126*q(27)^2-0.143*q(27)^3+0.563*q(27)^4)) ...
        +(0.1*(0.429*q(28)-1.126*q(28)^2-0.143*q(28)^3+0.563*q(28)^4)) ...
        +(0.1*(0.429*q(29)-1.126*q(29)^2-0.143*q(29)^3+0.563*q(29)^4))...
        +(0.1*(0.429*q(30)-1.126*q(30)^2-0.143*q(30)^3+0.563*q(30)^4))...
        +(0.1*(0.429*q(31)-1.126*q(31)^2-0.143*q(31)^3+0.563*q(31)^4)) ...
        +(0.1*(0.429*q(32)-1.126*q(32)^2-0.143*q(32)^3+0.563*q(32)^4))...
        +(0.1*(0.429*q(33)-1.126*q(33)^2-0.143*q(33)^3+0.563*q(33)^4)) ...
        +(0.1*(0.429*q(34)-1.126*q(34)^2-0.143*q(34)^3+0.563*q(34)^4)) ...
        +(0.1*(0.429*q(35)-1.126*q(35)^2-0.143*q(35)^3+0.563*q(35)^4))...
        +(0.1*(0.429*q(36)-1.126*q(36)^2-0.143*q(36)^3+0.563*q(36)^4))...
        +(0.1*(0.429*q(37)-1.126*q(37)^2-0.143*q(37)^3+0.563*q(37)^4))...
        +(0.1*(0.429*q(38)-1.126*q(38)^2-0.143*q(38)^3+0.563*q(38)^4)) ...
        +(0.1*(0.429*q(39)-1.126*q(39)^2-0.143*q(39)^3+0.563*q(39)^4)) ...
        +(0.1*(0.429*q(40)-1.126*q(40)^2-0.143*q(40)^3+0.563*q(40)^4))...
        +(0.1*(0.429*q(41)-1.126*q(41)^2-0.143*q(41)^3+0.563*q(41)^4))...
        +(0.1*(0.429*q(42)-1.126*q(42)^2-0.143*q(42)^3+0.563*q(42)^4))...
        +(0.1*(0.429*q(43)-1.126*q(43)^2-0.143*q(43)^3+0.563*q(43)^4))...
        +(0.1*(0.429*q(44)-1.126*q(44)^2-0.143*q(44)^3+0.563*q(44)^4))...
        +(0.1*(0.429*q(45)-1.126*q(45)^2-0.143*q(45)^3+0.563*q(45)^4))...
        +(0.1*(0.429*q(46)-1.126*q(46)^2-0.143*q(46)^3+0.563*q(46)^4))...
        +(0.1*(0.429*q(47)-1.126*q(47)^2-0.143*q(47)^3+0.563*q(47)^4))...
        +(0.1*(0.429*q(48)-1.126*q(48)^2-0.143*q(48)^3+0.563*q(48)^4))...
        +(0.1*(0.429*q(49)-1.126*q(49)^2-0.143*q(49)^3+0.563*q(49)^4))...
        +(0.1*(0.429*q(50)-1.126*q(50)^2-0.143*q(50)^3+0.563*q(50)^4))...
        +(0.1*(gamma*q(1)*q(2)))+(0.1*(gamma*q(2)*q(3)))+(0.1*(gamma*q(3)*q(4)))...
        +(0.1*(gamma*q(4)*q(5)))+(0.1*(gamma*q(5)*q(6)))+(0.1*(gamma*q(6)*q(7)))...
        +(0.1*(gamma*q(7)*q(8)))+(0.1*(gamma*q(8)*q(9)))+(0.1*(gamma*q(9)*q(10)))...
        +(0.1*(gamma*q(10)*q(11)))+(0.1*(gamma*q(11)*q(12)))+(0.1*(gamma*q(12)*q(13)))...
        +(0.1*(gamma*q(13)*q(14)))+(0.1*(gamma*q(14)*q(15)))+(0.1*(gamma*q(15)*q(16)))...
        +(0.1*(gamma*q(16)*q(17)))+(0.1*(gamma*q(17)*q(18)))+(0.1*(gamma*q(18)*q(19)))...
        +(0.1*(gamma*q(19)*q(20)))+(0.1*(gamma*q(20)*q(21)))+(0.1*(gamma*q(21)*q(22)))...
        +(0.1*(gamma*q(22)*q(23)))+(0.1*(gamma*q(23)*q(24)))+(0.1*(gamma*q(24)*q(25)))...
        +(0.1*(gamma*q(25)*q(26)))+(0.1*(gamma*q(26)*q(27)))+(0.1*(gamma*q(27)*q(28)))...
        +(0.1*(gamma*q(28)*q(29)))+(0.1*(gamma*q(29)*q(30)))+(0.1*(gamma*q(30)*q(31)))...
        +(0.1*(gamma*q(31)*q(32)))+(0.1*(gamma*q(32)*q(33)))+(0.1*(gamma*q(33)*q(34)))...
        +(0.1*(gamma*q(34)*q(35)))+(0.1*(gamma*q(35)*q(36)))+(0.1*(gamma*q(36)*q(37)))...
        +(0.1*(gamma*q(37)*q(38)))+(0.1*(gamma*q(38)*q(39)))+(0.1*(gamma*q(39)*q(40)))...
        +(0.1*(gamma*q(40)*q(41)))+(0.1*(gamma*q(41)*q(42)))+(0.1*(gamma*q(42)*q(43)))...
        +(0.1*(gamma*q(43)*q(44)))+(0.1*(gamma*q(44)*q(45)))+(0.1*(gamma*q(45)*q(46)))...
        +(0.1*(gamma*q(46)*q(47)))+(0.1*(gamma*q(47)*q(48)))+(0.1*(gamma*q(48)*q(49)))...
        +(0.1*(gamma*q(49)*q(50))));
    lb=[x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) ...
        x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) ...
        x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) ...
        x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) x(1) ...
        x(1) x(1)];
    ub=[x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx)...
        x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx)...
        x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx)...
        x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx) x(nx)...
        x(nx) x(nx)];
    A=[];
    b=[];
    Aeq=[];
    beq=[];
    q0=(lb+ub)/2;
end
analyminpos=fmincon(analyV,q0,A,b,Aeq,beq,lb,ub);
Emin=analyV(analyminpos);
analymaxpos=fmincon(analyVneg,q0,A,b,Aeq,beq,lb,ub);
Emax=pi^2/(2*1*dx^2)*d+analyV(analymaxpos);
DEp=Emax+Emin;
DEm=Emax-Emin;
dtm=DEm*tau/2;
dtp=DEp*tau/2;

%%
tic;
% Initial energy
rhox_tt = times(conj(G_tt),G_tt); % initial density |psi(x)|^2
PEnergy = real(dot(rhox_tt,PE_tt)*dx^d); % Potential energy
FT_G_tt = tt_FT(G_tt,dx,nx,1); % initial FTpsi(p)
rhop_tt = times(conj(FT_G_tt),FT_G_tt); % initial FT density |FTpsi(p)|^2
ENERGY = PEnergy + real(dot(rhop_tt,KE_tt)*dp^d); % Total initial energy
toc;
tic;

% Save initial state for survival amplitude calcs
G0_tt=G_tt; 
xi=zeros(1,ns); xic=zeros(1,ns); t=zeros(1,ns);
softnorm=zeros(1,ns); chebnorm=zeros(1,ns);

%%
figure;
tic;
Gc_tt=G0_tt;
softnorm(1)=(norm(G_tt)).^2*dx^d;
chebnorm(1)=(norm(Gc_tt)).^2*dx^d;
%  Propagation loop
for k=1:ns
    if (k > 1)
        % SOFT propagation
        G_tt=Trotter(G_tt,dx,nx,KP2_tt,...
            dp,np,eps,rmax,PPhalf_tt);
        softnorm(k)=(norm(G_tt)).^2*dx^d;
        % Clenshaw Chebyshev
        Gc_tt=clencheb(PE_tt,KE_tt,Gc_tt,DEp,DEm,dx,nx,dp,np,Npoly,eps,rmax,dtm)*exp(-1i*dtp);
        chebnorm(k)=(norm(Gc_tt)).^2*dx^d;
    end
    [memo{k},xi,xic,t]=PlotGc(G0_tt,G_tt,Gc_tt,xi,xic,d,k,t,tau,dx,ns);
    if mod(k-1,dump) == 0
        [t] = PlotWp(G_tt,Gc_tt,nx,d,r1,r2,k,t);
        filename=sprintf('%s%d%s','resultofstep',k-1,'.mat');
        save(filename)
    end
    disp(k-1)
end
toc;

%%
figure()
hold on;
plot(t(1:k)*2.418E-2,real(softnorm(1:k)),'k:','MarkerSize',15,'linewidth',2);
scatter(t(1:k)*2.418E-2,real(chebnorm(1:k)),250,'filled','b');
title('Norm','fontsize',18);
ylabel('Norm','fontsize',18);
xlabel('Time [fs]','fontsize',18);
xlim([0 ns*tau*2.418E-2]);
ylim([0.9 1.1])
legend('SOFT','Chebyshev')
hold off;

filename=sprintf('%s','resultofstepfinal.mat');
save(filename)